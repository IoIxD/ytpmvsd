{% extends 'base.html' %}

{% block content %}

    <div class="sample-box">
        <div class="sample-player-box">
            <video class="video" controls>
                <source src="{{ url_for('static', filename='media/samps/' + sample.filename) }}">
            </video>
            <h1>{{ sample.filename }}</h1>
            <p class="uploader">Uploaded by <a href="../user/{{ uploader.id }}">{{ uploader.username }}</a></p>
            <p class="upload-date" data-utc="{{ sample.upload_date.isoformat() }}"></p>
            <script>
                document.querySelectorAll('.upload-date').forEach(element => {
                    const utcDate = element.getAttribute('data-utc');
                    const localTime = moment.utc(utcDate).local();
                    element.innerText = 'Uploaded ' + localTime.fromNow();
                });
            </script>
        </div>
        <div class="sample-info-box">
            <a href="{{ url_for('static', filename='media/samps/' + sample.filename) }}"
               download="{{ sample.filename }}"
               class="sample-page-button" style="--hue: 100">
                <span>Download sample</span>
            </a>
            <a class="sample-page-button like-button" data-sample-id="{{ sample.id }}" style="--hue: 200">
                <span>{% if current_user in sample.likes %}Unlike{% else %}Like{% endif %}</span>
                <span class="like-count">{{ sample.likes|length }}</span>
            </a>
            {% if current_user.is_admin %}
                <a class="sample-page-button delete-button" data-sample-id="{{ sample.id }}" style="--hue: 0">
                    <span>Delete sample</span>
                </a>
            {% endif %}
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".like-button").forEach(button => {
                button.addEventListener("click", function () {

                    {% if current_user.is_authenticated %}
                        const sampleId = this.getAttribute("data-sample-id");
                        const likeCountSpan = this.querySelector(".like-count");

                        console.log("Step 1 complete");

                        fetch(`/sample/like/${sampleId}`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            }
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    likeCountSpan.textContent = data.likes;
                                    this.querySelector("span").textContent = data.liked ? "Unlike" : "Like";  // Change text
                                }
                            });
                        {#window.alert("You are logged in, but I haven't implemented liking yet!");#}
                    {% else %}
                        window.alert("You are not logged in!");
                    {% endif %}
                });
            });
        });
    </script>

    {% if current_user.is_admin %}
        <script>
            document.querySelector('.delete-button').addEventListener("click", function () {
                const sampleId = this.getAttribute("data-sample-id");

                fetch(`/sample/delete/${sampleId}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        window.alert(data.message);
                        window.location = '/';
                    })
                    .catch(error => console.error("Error:", error));
            });
        </script>
    {% endif %}

{% endblock %}